---
# NOTE: handling formating and mounting manually.
# https://github.com/siderolabs/talos/issues/8367
# https://github.com/michaelbeaumont/k8rn/blob/main/k8s/job-add-data-partition.tf
apiVersion: batch/v1
kind: Job
metadata:
  name: disk-encryption-hdd-storage1
  namespace: kube-system
spec:
  template:
    spec:
      nodeSelector:
        kubernetes.io/hostname: storage1
      containers:
        - name: encrypt-disk
          image: ghcr.io/frzifus/gdisk:latest
          imagePullPolicy: IfNotPresent
          command:
            - bash
            - -c
            - |
              set -e
              sleep 3600
              disk=/dev/sda
              mount_point=/var/mnt/data-storage

              passphrase=$(cat /etc/secrets/passphrase | tr -d '\n\t\r ')

              if [[ -b /dev/sda1 ]]; then
                  cryptsetup luksDump /dev/sda1
                  echo "Data partition already exists"
                  # Check if the LUKS device is already open
                  # NOTE: Close it manually..
                  # umount "$mount_point"
                  # cryptsetup close data-crypt
                  # NOTE: reset maunally..
                  # # Wipe partition
                  # sgdisk --zap-all "${disk}"
                  # # Remove luks superblock
                  # dd if=/dev/zero of=/dev/sda1 bs=512 count=2048
                  if cryptsetup status data-crypt > /dev/null 2>&1; then
                      echo "LUKS device already open, skipping open step."
                  else
                      echo "$passphrase" | cryptsetup open "${disk}1" data-crypt -
                  fi

                  mkdir -p "$mount_point"

                  if mount | grep -q "$mount_point"; then
                      echo "Partition already mounted at $mount_point"
                  else
                      mount /dev/mapper/data-crypt "$mount_point"
                      echo "Partition mounted at $mount_point"
                  fi

                  exit 0
              fi

              echo "No data partition found"
              # Create a new partition and label it "data"
              sgdisk -p "$disk"
              sgdisk --new=1:0:0 --change-name=1:data --typecode=1:8300 "$disk"
              # partprobe, NOTE: missing udevadm
              sgdisk -p "$disk"

              # Encrypt the partition with LUKS2
              echo -n "$passphrase" | cryptsetup luksFormat --type luks2 "${disk}1" -
              echo -n "$passphrase" | cryptsetup open "${disk}1" data-crypt -

              mkfs.xfs /dev/mapper/data-crypt

              mkdir -p "$mount_point"

              mount /dev/mapper/data-crypt "$mount_point"
              echo "Partition created, encrypted, formatted, and mounted at $mount_point"
          volumeMounts:
            - mountPath: /etc/secrets
              name: luks-passphrase-secret
              readOnly: true
            - mountPath: /dev
              name: dev
            - mountPath: /var
              name: var
          securityContext:
            privileged: true
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: false
        seccompProfile:
          type: RuntimeDefault
      volumes:
        - name: luks-passphrase-secret
          secret:
            secretName: disk-encryption-storage1-passphrase
        - name: dev
          hostPath:
            path: /dev
            type: Directory
        - name: var
          hostPath:
            path: /var
            type: Directory
